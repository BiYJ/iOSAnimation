
原文：[CoreAnimation](https://www.cnblogs.com/kenshincui/p/3972100.html#coreanimation)
官方文档：[Core Animation](https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/CoreAnimation_guide/Introduction/Introduction.html)


iOS 的核心动画 Core Animation（包含在 `Quartz Core` 框架中），是`负责图形渲染与动画的基础框架`。Core Animation 可以作用于动画视图或者其他可视元素，为你完成了动画所需的大部分绘帧工作。你只需要配置少量的动画参数（如开始点的位置和结束点的位置）即可使用 Core Animation 的动画效果。Core Animation 将大部分实际的绘图任务交给了图形硬件来处理，图形硬件会加速图形渲染的速度。这种自动化的图形加速技术让动画拥有更高的帧率并且显示效果更加平滑，不会加重 CPU 的负担而影响程序的运行速度。

在 iOS 中核心动画分为几类：基础动画、关键帧动画、动画组、转场动画。各个类的关系大致如下：

![](https://images0.cnblogs.com/blog/62046/201409/150628400188786.png)


- CAAnimation：核心动画的基础类，不能直接使用，负责动画运行时间、速度的控制，本身`实现了CAMediaTiming协议`。
- CAPropertyAnimation：属性动画的基类（通过属性进行动画设置，注意是可动画属性），不能直接使用。
- CAAnimationGroup：动画组，动画组是`一种组合模式设计`，可以通过动画组来进行所有动画行为的统一控制，组中所有动画效果可以并发执行。
- CATransition：转场动画，主要通过滤镜进行动画效果设置。
- CABasicAnimation：基础动画，通过属性修改进行动画参数控制，`只有初始状态和结束状态`。
- CAKeyframeAnimation：关键帧动画，同样是通过属性进行动画参数控制，但是同基础动画不同的是它可以有多个状态控制。

基础动画、关键帧动画都属于属性动画，就是`通过修改属性值产生动画效果`，开发人员只需要设置初始值和结束值，中间的过程动画（又叫“补间动画”）由系统自动计算产生。

和基础动画不同的是关键帧动画`可以设置多个属性值`，每两个属性中间的补间动画由系统自动完成，因此从这个角度而言，基础动画又可以看成是只有两个关键帧的关键帧动画。


## 基础动画

如果不使用UIView封装的方法，动画创建一般分为以下几步：

1. 初始化动画并设置动画属性
2. 设置动画属性初始值（可以省略）、结束值以及其他动画属性
3. 给图层添加动画


图层动画的本质就是`将图层内部的内容转化为位图经硬件操作形成一种动画效果，其实图层本身并没有任何的变化`。

position 动画中图层并没有因为动画效果而改变它的位置（对于缩放动画其大小也是不会改变的），所以动画完成之后图层还是在原来的显示位置没有任何变化，如果这个图层在一个 UIView 中你会发现在 UIView 移动过程中你要触发 UIView 的点击事件也只能点击原来的位置（即使它已经运动到了别的位置），因为它的位置从来没有变过。

动画运行完成后，手动设置图层的 position，会重新从起始点运动到终点。这个问题产生的原因是：对于非根图层，设置图层的可动画属性（在动画结束后重新设置了 position，而 position 是可动画属性）会产生动画效果。解决这个问题有两种办法：

1. 关闭图层隐式动画
2. 设置动画图层为根图层


> 图层的形变都是基于锚点进行的。例如旋转，旋转的中心点就是图层的锚点。

核心动画的运行有一个`媒体时间`的概念，假设将一个旋转动画设置旋转一周用时 60 秒的话，那么当动画旋转 90 度后媒体时间就是 15 秒。如果此时要将动画暂停只需要让媒体时间偏移量设置为 15 秒即可，并把动画运行速度设置为 0 使其停止运动。类似的，如果又过了 60 秒后需要恢复动画（此时媒体时间为 75 秒），这时只要将动画开始开始时间设置为当前媒体时间 75 秒减去暂停时的时间（也就是之前定格动画时的偏移量）15秒（开始时间 = 75 - 15 = 60 秒），那么动画就会重新计算 60 秒后的状态再开始运行，与此同时将偏移量重新设置为 0 并且把运行速度设置 1。`这个过程中真正起到暂停动画和恢复动画的其实是动画速度的调整，媒体时间偏移量以及恢复时的开始时间设置主要为了让动画更加连贯`。

下面的代码演示了移动动画结束后旋转动画暂停，并且当再次点击动画时旋转恢复的过程(注意在移动过程中如果再次点击屏幕可以暂停移动和旋转动画，再次点击可以恢复两种动画。但是当移动结束后触发了移动动画的完成事件如果再次点击屏幕则只能恢复旋转动画，因为此时移动动画已经结束而不是暂停，无法再恢复)。

注意：

1. 动画暂停针对的是图层而不是图层中的某个动画。
2. 要做无限循环的动画，动画的removedOnCompletion属性必须设置为NO，否则运行一次动画就会销毁。


## 关键帧动画

这种动画方式在 flash 开发中经常用到。关键帧动画就是在动画控制过程中`开发者指定主要的动画状态`，至于各个状态间动画如何进行则由系统自动运算补充（每两个关键帧之间系统形成的动画称为`“补间动画”`），这种动画的好处就是开发者不用逐个控制每个动画帧，而只要关心几个关键帧的状态即可。

关键帧动画开发分为两种形式：

1. 通过设置不同的属性值进行关键帧控制
2. 通过绘制路径进行关键帧控制。优先级高于前者，如果设置了路径，则属性值就不再起作用。


对于路径类型的关键帧动画系统是从描绘路径的位置开始路径，直到路径结束。如果上面的路径不是贝塞尔曲线而是矩形路径那么它会从矩形的左上角开始运行，顺时针一周回到左上角；如果指定的路径是一个椭圆，那么动画运行的路径是从椭圆右侧开始（0度）顺时针一周回到右侧。

keyTimes：各个关键帧的时间控制。前面使用values设置了四个关键帧，默认情况下每两帧之间的间隔为:8/(4-1)秒。如果想要控制动画从第一帧到第二针占用时间4秒，从第二帧到第三帧时间为2秒，而从第三帧到第四帧时间2秒的话，就可以通过keyTimes进行设置。keyTimes中存储的是时间占用比例点，此时可以设置keyTimes的值为0.0，0.5，0.75，1.0（当然必须转换为NSNumber），也就是说1到2帧运行到总时间的50%，2到3帧运行到总时间的75%，3到4帧运行到8秒结束。

caculationMode：动画计算模式。还拿上面keyValues动画举例，之所以1到2帧能形成连贯性动画而不是直接从第1帧经过8/3秒到第2帧是因为动画模式是连续的（值为kCAAnimationLinear，这是计算模式的默认值）；而如果指定了动画模式为kCAAnimationDiscrete离散的那么你会看到动画从第1帧经过8/3秒直接到第2帧，中间没有任何过渡。其他动画模式还有：kCAAnimationPaced（均匀执行，会忽略keyTimes）、kCAAnimationCubic（平滑执行，对于位置变动关键帧动画运行轨迹更平滑）、kCAAnimationCubicPaced（平滑均匀执行）。


## 动画组

实际开发中一个物体的运动往往是`复合运动`，单一属性的运动情况比较少，但恰恰`属性动画每次进行动画设置时一次只能设置一个属性进行动画控制`（不管是基础动画还是关键帧动画都是如此），这样一来要做一个复合运动的动画就必须创建多个属性动画进行组合。对于一两种动画的组合或许处理起来还比较容易，但是对于更多动画的组合控制往往会变得很麻烦，动画组的产生就是基于这样一种情况而产生的。动画组是一系列动画的组合，凡是添加到动画组中的动画都受控于动画组，这样一来各类动画公共的行为就可以统一进行控制而不必单独设置，而且放到动画组中的各个动画可以并发执行，共同构建出复杂的动画效果。

![](https://images0.cnblogs.com/blog/62046/201409/150628462536981.gif)


## 转场动画

![](https://images0.cnblogs.com/blog/62046/201409/150628476122467.gif)

转场动画就是从一个场景以动画的形式过渡到另一个场景。转场动画的使用一般分为以下几个步骤：

1. 创建转场动画
2. 设置转场类型、子类型（可选）及其他属性
3. 设置转场后的新视图并添加动画到图层

下表列出了常用的转场类型(注意私有API是苹果官方没有公开的动画类型，但是目前通过仍然可以使用)：

|动画类型|说明|对应常量	|是否支持方向设置|
|:----|:-----|:------|:------|
|公开API||               
|fade|淡出效果|kCATransitionFade|是|
|movein|新视图移动到旧视图上|kCATransitionMoveIn|是|
|push|新视图推出旧视图|kCATransitionPush|是|
|reveal|移开旧视图显示新视图|kCATransitionReveal|是|
|||||
|私有API|私有API只能通过字符串访问|||     
|cube|立方体翻转效果|无|是|
|oglFlip|翻转效果|无|是|
|suckEffect|收缩效果|无|否|
|rippleEffect|水滴波纹效果|无|否|
|pageCurl|向上翻页效果|无|是|
|pageUnCurl|向下翻页效果|无|是|
|cameralIrisHollowOpen|摄像头打开效果|无|否|
|cameraIrisHollowClose|摄像头关闭效果|无|否|

|动画子类型|说明|
|:------|:-------|
|kCATransitionFromRight|从右侧转场|
|kCATransitionFromLeft|从左侧转场|
|kCATransitionFromTop|从顶部转场|
|kCATransitionFromBottom|从底部转场|


## 逐帧动画

![](https://images0.cnblogs.com/blog/62046/201409/150629072843824.gif)

前面介绍了核心动画中大部分动画类型，在动画制作中还有一种动画类型“逐帧动画”。

说到逐帧动画，第一个想到的就是 UIImageView，通过设置 UIImageView 的 `animationImages` 属性，然后调用它的`startAnimating` 方法去播放这组图片。当然这种方法在某些场景下是可以达到逐帧的动画效果，但是它也存在着很大的`性能问题`，并且这种方法一旦设置完图片中间的过程就`无法控制`了。

当然，也许会想到利用 iOS 的定时器 NSTimer 定时更新图片来达到逐帧动画的效果。这种方式确实可以解决 UIImageView 一次性加载大量图片的问题，而且让播放过程可控，唯一的缺点就是`定时器方法调用有时可能会因为当前系统执行某种比较占用时间的任务造成动画连续性出现问题`。

虽然在核心动画没有直接提供逐帧动画类型，但是却提供了用于完成逐帧动画的相关对象 `CADisplayLink`。CADisplayLink 是一个计时器，但是同 NSTimer 不同的是，`CADisplayLink 的刷新周期同屏幕完全一致`。例如在 iOS 中屏幕刷新周期是 60 次/秒，CADisplayLink 刷新周期同屏幕刷新一致也是 `60 次/秒`，这样一来使用它完成的逐帧动画（又称为`“时钟动画”`）完全感觉不到动画的停滞情况。

iOS 程序在运行后就进入一个消息循环中（这个消息循环称为“主运行循环”），整个程序相当于进入一个死循环中，始终等待用户输入。将 CADisplayLink 加入到主运行循环队列后，它的时钟周期就和主运行循环保持一致，而主运行循环周期就是屏幕刷新周期。在 CADisplayLink 加入到主运行循环队列后就会`循环调用目标方法`，在这个方法中更新视图内容就可以完成逐帧动画。

当然这里不得不强调的是`逐帧动画性能势必较低`，但是对于一些事物的运动又不得不选择使用逐帧动画，例如人的运动，这是一个高度复杂的运动，基本动画、关键帧动画是不可能解决的。所大家一定要注意在循环方法中尽可能的降低算法复杂度，同时保证循环过程中内存峰值尽可能低。
